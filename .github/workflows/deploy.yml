name: Deploy to Hostinger VPS

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to VPS
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          password: ${{ secrets.VPS_PASSWORD }}
          port: 22
          script: |
            export DOMAIN="${{ secrets.DOMAIN }}"
            export REPO="https://github.com/${{ github.repository }}.git"
            
            # 1. Ensure Directory Exists (Clone if missing)
            if [ ! -d "/opt/ontru" ]; then
                echo "Directory /opt/ontru does not exist. Cloning repository..."
                git clone $REPO /opt/ontru
            fi
            
            cd /opt/ontru
            
            # 2. Pull Latest Changes
            echo "Pulling latest changes..."
            git fetch origin
            git reset --hard origin/main
            
            # 3. Execution Permission
            chmod +x deploy/deploy.sh
            
            # 4. Run Deployment
            if [ -f .env ]; then
                echo "Existing installation found. Updating..."
                ./deploy/deploy.sh --update
            else
                echo "Fresh installation. Setting up for domain: $DOMAIN"
                ./deploy/deploy.sh $DOMAIN
            fi
